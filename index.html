import { useState, useEffect, useRef } from 'react';
import { Send, Copy, Check, Receipt, FileText, AlertCircle, Calculator, TrendingUp, Download, History, BarChart3, Mail, Upload, Trash2, Eye, Filter, Calendar, Bell, FileSignature, X } from 'lucide-react';

export default function InvoiceManagementApp() {
  const [activeTab, setActiveTab] = useState('new');
  const [documentType, setDocumentType] = useState('invoice');
  const [clientName, setClientName] = useState('');
  const [documentNumber, setDocumentNumber] = useState('');
  const [amount, setAmount] = useState('');
  const [dueDate, setDueDate] = useState('');
  const [issueDate, setIssueDate] = useState('');
  const [serviceDescription, setServiceDescription] = useState('');
  const [validityDays, setValidityDays] = useState('30');
  const [daysOverdue, setDaysOverdue] = useState('');
  const [generatedEmail, setGeneratedEmail] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [copied, setCopied] = useState(false);
  
  // Signature
  const [signature, setSignature] = useState('');
  const [signatureImage, setSignatureImage] = useState(null);
  const fileInputRef = useRef(null);
  
  // Rappels
  const [reminders, setReminders] = useState([]);
  const [showReminders, setShowReminders] = useState(false);
  
  // Historique et statistiques
  const [history, setHistory] = useState([]);
  const [stats, setStats] = useState({
    totalSent: 0,
    totalAmount: 0,
    totalRecovered: 0,
    pendingAmount: 0,
    byType: {}
  });
  const [filterType, setFilterType] = useState('all');
  const [filterStatus, setFilterStatus] = useState('all');

  // Import
  const [importedData, setImportedData] = useState([]);
  const [showImportPreview, setShowImportPreview] = useState(false);

  // Calculs des pÃ©nalitÃ©s
  const [penaltiesAmount, setPenaltiesAmount] = useState(0);
  const [forfaitaryIndemnity] = useState(4800);
  const [totalDue, setTotalDue] = useState(0);
  const [legalMinRate] = useState(11.13);
  const [conventionalRate] = useState(18);

  // Charger au dÃ©marrage
  useEffect(() => {
    loadHistory();
    loadSignature();
    checkReminders();
  }, []);

  // VÃ©rifier les rappels rÃ©guliÃ¨rement
  useEffect(() => {
    const interval = setInterval(() => {
      checkReminders();
    }, 60000); // Chaque minute
    return () => clearInterval(interval);
  }, [history]);

  const loadHistory = async () => {
    try {
      const result = await window.storage.get('invoice-history');
      if (result && result.value) {
        const historyData = JSON.parse(result.value);
        setHistory(historyData);
        calculateStats(historyData);
      }
    } catch (error) {
      console.log('Historique vide:', error);
      setHistory([]);
    }
  };

  const loadSignature = async () => {
    try {
      const result = await window.storage.get('user-signature');
      if (result && result.value) {
        const sigData = JSON.parse(result.value);
        setSignature(sigData.text || '');
        setSignatureImage(sigData.image || null);
      }
    } catch (error) {
      console.log('Pas de signature:', error);
    }
  };

  const saveSignature = async () => {
    try {
      await window.storage.set('user-signature', JSON.stringify({
        text: signature,
        image: signatureImage
      }));
      alert('Signature enregistrÃ©e !');
    } catch (error) {
      console.error('Erreur sauvegarde signature:', error);
    }
  };

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        setSignatureImage(event.target.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const checkReminders = () => {
    const today = new Date();
    const alerts = [];
    
    history.forEach(entry => {
      if (entry.status !== 'paid' && entry.dueDate) {
        const dueDate = parseDateString(entry.dueDate);
        if (dueDate) {
          const diffTime = dueDate - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          if (diffDays <= 7 && diffDays >= 0) {
            alerts.push({
              id: entry.id,
              client: entry.clientName,
              docNumber: entry.documentNumber,
              amount: entry.amount,
              daysUntil: diffDays,
              type: 'upcoming'
            });
          } else if (diffDays < 0) {
            alerts.push({
              id: entry.id,
              client: entry.clientName,
              docNumber: entry.documentNumber,
              amount: entry.totalDue || entry.amount,
              daysOverdue: Math.abs(diffDays),
              type: 'overdue'
            });
          }
        }
      }
    });
    
    setReminders(alerts);
  };

  const parseDateString = (dateStr) => {
    if (!dateStr) return null;
    // Format: DD/MM/YYYY
    const parts = dateStr.split('/');
    if (parts.length === 3) {
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    return null;
  };

  const saveToHistory = async (data) => {
    const newEntry = {
      id: Date.now(),
      date: new Date().toISOString(),
      type: documentType,
      clientName,
      documentNumber,
      amount: parseFloat(amount.replace(/\s/g, '')),
      dueDate,
      daysOverdue: daysOverdue || 0,
      penaltiesAmount,
      totalDue: totalDue || parseFloat(amount.replace(/\s/g, '')),
      email: generatedEmail,
      status: 'sent'
    };

    const updatedHistory = [newEntry, ...history];
    setHistory(updatedHistory);
    
    try {
      await window.storage.set('invoice-history', JSON.stringify(updatedHistory));
      calculateStats(updatedHistory);
      checkReminders();
    } catch (error) {
      console.error('Erreur sauvegarde:', error);
    }
  };

  const updateEntryStatus = async (id, newStatus) => {
    const updatedHistory = history.map(entry => 
      entry.id === id ? { ...entry, status: newStatus } : entry
    );
    setHistory(updatedHistory);
    
    try {
      await window.storage.set('invoice-history', JSON.stringify(updatedHistory));
      calculateStats(updatedHistory);
      checkReminders();
    } catch (error) {
      console.error('Erreur mise Ã  jour:', error);
    }
  };

  const deleteEntry = async (id) => {
    const updatedHistory = history.filter(entry => entry.id !== id);
    setHistory(updatedHistory);
    
    try {
      await window.storage.set('invoice-history', JSON.stringify(updatedHistory));
      calculateStats(updatedHistory);
      checkReminders();
    } catch (error) {
      console.error('Erreur suppression:', error);
    }
  };

  const calculateStats = (data) => {
    const stats = {
      totalSent: data.length,
      totalAmount: 0,
      totalRecovered: 0,
      pendingAmount: 0,
      byType: {
        invoice: 0,
        quote: 0,
        reminder1: 0,
        reminder2: 0,
        final: 0
      }
    };

    data.forEach(entry => {
      stats.totalAmount += entry.amount;
      if (entry.status === 'paid') {
        stats.totalRecovered += entry.totalDue;
      } else {
        stats.pendingAmount += entry.totalDue;
      }
      if (stats.byType[entry.type] !== undefined) {
        stats.byType[entry.type]++;
      }
    });

    setStats(stats);
  };

  const handleFileImport = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      parseCSV(text);
    };
    reader.readAsText(file);
  };

  const parseCSV = (text) => {
    const lines = text.split('\n').filter(line => line.trim());
    const data = [];
    
    // Ignorer la premiÃ¨re ligne (en-tÃªtes)
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;
      
      // Parser CSV (gÃ¨re les virgules dans les guillemets)
      const values = [];
      let current = '';
      let inQuotes = false;
      
      for (let char of line) {
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          values.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      values.push(current.trim());
      
      if (values.length >= 4) {
        data.push({
          client: values[0].replace(/"/g, ''),
          numero: values[1].replace(/"/g, ''),
          montant: values[2].replace(/"/g, '').replace(/\s/g, ''),
          echeance: values[3].replace(/"/g, '')
        });
      }
    }
    
    setImportedData(data);
    setShowImportPreview(true);
  };

  const confirmImport = async () => {
    const newEntries = importedData.map(item => ({
      id: Date.now() + Math.random(),
      date: new Date().toISOString(),
      type: 'invoice',
      clientName: item.client,
      documentNumber: item.numero,
      amount: parseFloat(item.montant),
      dueDate: item.echeance,
      daysOverdue: 0,
      penaltiesAmount: 0,
      totalDue: parseFloat(item.montant),
      email: '',
      status: 'sent'
    }));

    const updatedHistory = [...newEntries, ...history];
    setHistory(updatedHistory);
    
    try {
      await window.storage.set('invoice-history', JSON.stringify(updatedHistory));
      calculateStats(updatedHistory);
      checkReminders();
      setShowImportPreview(false);
      setImportedData([]);
      alert(`${newEntries.length} factures importÃ©es avec succÃ¨s !`);
    } catch (error) {
      console.error('Erreur import:', error);
      alert('Erreur lors de l\'import');
    }
  };

  const exportToPDF = async () => {
    // CrÃ©er le contenu du PDF
    const pdfContent = `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              DEPANN'FROID
      Maintenance Frigorifique - PolynÃ©sie FranÃ§aise
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

${documentType === 'quote' ? 'DEVIS' : documentType === 'invoice' ? 'FACTURE' : 'RELANCE'}

Date de gÃ©nÃ©ration: ${new Date().toLocaleDateString('fr-FR')}
Document NÂ°: ${documentNumber}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CLIENT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${clientName}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DÃ‰TAILS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Montant: ${amount} XPF
${dueDate ? `Ã‰chÃ©ance: ${dueDate}` : ''}
${daysOverdue ? `Retard: ${daysOverdue} jours` : ''}

${serviceDescription ? `Service: ${serviceDescription}` : ''}

${penaltiesAmount > 0 ? `
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PÃ‰NALITÃ‰S DE RETARD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Montant initial:           ${formatNumber(amount)} XPF
PÃ©nalitÃ©s (18%/an):        ${formatNumber(penaltiesAmount)} XPF
IndemnitÃ© forfaitaire:     ${formatNumber(forfaitaryIndemnity)} XPF
                          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOTAL DÃ›:                  ${formatNumber(totalDue)} XPF
` : ''}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MESSAGE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

${generatedEmail}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CONDITIONS DE PAIEMENT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DÃ©lai: 30 jours
PÃ©nalitÃ©s de retard: 18% par an
IndemnitÃ© forfaitaire: 4 800 XPF

ConformÃ©ment Ã  la loi du Pays nÂ° 2015-4 du 14 avril 2015

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SIGNATURE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

${signature || 'Lionel - GÃ©rant DEPANN\'FROID'}

${signatureImage ? '[Signature numÃ©rique jointe]' : ''}

Contact: depannfroid@mail.pf
TAHITI: [Votre NÂ° TAHITI]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    `;

    // TÃ©lÃ©charger comme fichier texte formatÃ© (simule un PDF)
    const blob = new Blob([pdfContent], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${documentType}-${documentNumber || 'document'}-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  // Calcul automatique des pÃ©nalitÃ©s
  useEffect(() => {
    if (amount && daysOverdue) {
      const amountNum = parseFloat(amount.replace(/\s/g, ''));
      const days = parseInt(daysOverdue);
      
      if (!isNaN(amountNum) && !isNaN(days) && days > 0) {
        const penalties = (amountNum * conventionalRate * days) / (365 * 100);
        setPenaltiesAmount(Math.round(penalties));
        setTotalDue(Math.round(amountNum + penalties + forfaitaryIndemnity));
      } else {
        setPenaltiesAmount(0);
        setTotalDue(0);
      }
    } else {
      setPenaltiesAmount(0);
      setTotalDue(0);
    }
  }, [amount, daysOverdue, conventionalRate, forfaitaryIndemnity]);

  const documentTypes = [
    { value: 'invoice', label: 'Ã‰mission Facture', icon: 'ğŸ“„', color: 'blue', description: 'Envoi de la facture au client' },
    { value: 'quote', label: 'Ã‰mission Devis', icon: 'ğŸ“‹', color: 'green', description: 'Envoi du devis au client' },
    { value: 'reminder1', label: '1Ã¨re Relance', icon: 'ğŸ“§', color: 'yellow', description: 'Rappel amical' },
    { value: 'reminder2', label: '2Ã¨me Relance', icon: 'âš ï¸', color: 'orange', description: 'Ton ferme' },
    { value: 'final', label: 'Relance Finale', icon: 'ğŸš¨', color: 'red', description: 'Avant mise en demeure' }
  ];

  const getColorClasses = (color) => {
    const colors = {
      blue: { bg: 'bg-blue-100', text: 'text-blue-600', border: 'border-blue-500', hover: 'hover:bg-blue-50' },
      green: { bg: 'bg-green-100', text: 'text-green-600', border: 'border-green-500', hover: 'hover:bg-green-50' },
      yellow: { bg: 'bg-yellow-100', text: 'text-yellow-600', border: 'border-yellow-500', hover: 'hover:bg-yellow-50' },
      orange: { bg: 'bg-orange-100', text: 'text-orange-600', border: 'border-orange-500', hover: 'hover:bg-orange-50' },
      red: { bg: 'bg-red-100', text: 'text-red-600', border: 'border-red-500', hover: 'hover:bg-red-50' }
    };
    return colors[color];
  };

  const formatNumber = (num) => {
    return new Intl.NumberFormat('fr-FR').format(num);
  };

  const generateEmail = async () => {
    if (!clientName.trim() || !documentNumber.trim() || !amount.trim()) return;

    setIsLoading(true);
    try {
      let prompt = '';
      
      if (documentType === 'invoice') {
        prompt = `Tu es Lionel, propriÃ©taire de DEPANN'FROID, entreprise de maintenance frigorifique en PolynÃ©sie franÃ§aise. RÃ©dige un email professionnel d'envoi de facture.

Informations :
- Nom du client : ${clientName}
- NumÃ©ro de facture : ${documentNumber}
- Montant : ${amount} XPF
${issueDate ? `- Date d'Ã©mission : ${issueDate}` : ''}
${dueDate ? `- Date d'Ã©chÃ©ance : ${dueDate}` : ''}
${serviceDescription ? `- Service fourni : ${serviceDescription}` : ''}

MENTIONS OBLIGATOIRES Ã  inclure en fin d'email :
"Conditions de rÃ¨glement : Paiement Ã  30 jours
En cas de retard de paiement, pÃ©nalitÃ©s exigibles de plein droit :
- Taux d'intÃ©rÃªt : 18% par an
- IndemnitÃ© forfaitaire de recouvrement : 4 800 XPF"

Ton : Professionnel, courtois et clair
Structure :
- Salutation chaleureuse
- Annonce de l'envoi de la facture en piÃ¨ce jointe
- Rappel bref du service fourni
- Remerciements pour la confiance
- DisponibilitÃ© pour toute question
- Conditions de paiement (OBLIGATOIRE)
- Formule de politesse professionnelle

L'email doit reflÃ©ter les valeurs polynÃ©siennes de respect et proximitÃ© client.`;

      } else if (documentType === 'quote') {
        prompt = `Tu es Lionel, propriÃ©taire de DEPANN'FROID, entreprise de maintenance frigorifique en PolynÃ©sie franÃ§aise. RÃ©dige un email professionnel d'envoi de devis.

Informations :
- Nom du client : ${clientName}
- NumÃ©ro de devis : ${documentNumber}
- Montant : ${amount} XPF
${issueDate ? `- Date d'Ã©mission : ${issueDate}` : ''}
${validityDays ? `- ValiditÃ© : ${validityDays} jours` : ''}
${serviceDescription ? `- Prestation proposÃ©e : ${serviceDescription}` : ''}

Ton : Professionnel, persuasif et rassurant
Structure :
- Salutation personnalisÃ©e
- Suite Ã  votre demande/Ã©change
- PrÃ©sentation du devis en piÃ¨ce jointe
- Mise en avant de la valeur ajoutÃ©e (expertise 15 ans, qualitÃ©, disponibilitÃ©)
- ValiditÃ© du devis
- Invitation Ã  poser des questions
- Appel Ã  l'action (validation du devis)
- Formule de politesse chaleureuse

Valorise l'expertise technique et la proximitÃ© de service en PolynÃ©sie.`;

      } else if (documentType === 'reminder1') {
        const penaltyInfo = daysOverdue ? `

CALCUL DES PÃ‰NALITÃ‰S (Ã  mentionner) :
- Montant initial : ${formatNumber(amount)} XPF
- Jours de retard : ${daysOverdue}
- PÃ©nalitÃ©s (18%/an) : ${formatNumber(penaltiesAmount)} XPF
- IndemnitÃ© forfaitaire : ${formatNumber(forfaitaryIndemnity)} XPF
- TOTAL DÃ› : ${formatNumber(totalDue)} XPF` : '';

        prompt = `Tu es Lionel, propriÃ©taire de DEPANN'FROID en PolynÃ©sie franÃ§aise. RÃ©dige un email de premiÃ¨re relance amicale pour une facture impayÃ©e.

Informations :
- Nom du client : ${clientName}
- NumÃ©ro de facture : ${documentNumber}
- Montant initial : ${amount} XPF
${dueDate ? `- Date d'Ã©chÃ©ance : ${dueDate}` : ''}
${daysOverdue ? `- Jours de retard : ${daysOverdue}` : ''}
${serviceDescription ? `- Service fourni : ${serviceDescription}` : ''}${penaltyInfo}

Ton : Amical et courtois, rappel bienveillant
Structure :
- Salutation chaleureuse
- Rappel du service fourni avec professionnalisme
- Mention polie de la facture impayÃ©e et de l'Ã©chÃ©ance dÃ©passÃ©e
${daysOverdue ? '- Information sur les pÃ©nalitÃ©s encourues (calcul dÃ©taillÃ© ci-dessus)' : ''}
- Proposition d'aide en cas de problÃ¨me (Ã©talement, difficultÃ©s temporaires)
- Demande de rÃ©gularisation rapide
- Formule de politesse professionnelle

Reste bienveillant tout en Ã©tant clair sur les obligations lÃ©gales.`;

      } else if (documentType === 'reminder2') {
        const penaltyInfo = daysOverdue ? `

CALCUL DES PÃ‰NALITÃ‰S (Ã  mentionner clairement) :
- Montant initial : ${formatNumber(amount)} XPF
- Jours de retard : ${daysOverdue}
- PÃ©nalitÃ©s (18%/an) : ${formatNumber(penaltiesAmount)} XPF
- IndemnitÃ© forfaitaire : ${formatNumber(forfaitaryIndemnity)} XPF
- TOTAL DÃ› : ${formatNumber(totalDue)} XPF` : '';

        prompt = `Tu es Lionel, propriÃ©taire de DEPANN'FROID en PolynÃ©sie franÃ§aise. RÃ©dige un email de deuxiÃ¨me relance plus ferme pour une facture impayÃ©e.

Informations :
- Nom du client : ${clientName}
- NumÃ©ro de facture : ${documentNumber}
- Montant initial : ${amount} XPF
${dueDate ? `- Date d'Ã©chÃ©ance : ${dueDate}` : ''}
${daysOverdue ? `- Jours de retard : ${daysOverdue}` : ''}
${serviceDescription ? `- Service fourni : ${serviceDescription}` : ''}${penaltyInfo}

Ton : Professionnel et ferme, mais toujours respectueux
Structure :
- Rappel de la premiÃ¨re relance restÃ©e sans rÃ©ponse
- Constat du retard persistant
- Calcul dÃ©taillÃ© des pÃ©nalitÃ©s appliquÃ©es (montant prÃ©cis)
- Demande CLAIRE de rÃ©gularisation IMMÃ‰DIATE
- DÃ©lai final (gÃ©nÃ©ralement 8 jours)
- Mention des consÃ©quences (procÃ©dure de recouvrement)
- DerniÃ¨re ouverture au dialogue
- Formule ferme mais professionnelle

Sois direct et factuel, avec les montants prÃ©cis.`;

      } else {
        const penaltyInfo = daysOverdue ? `

CALCUL DES PÃ‰NALITÃ‰S (Ã  mentionner avec fermetÃ©) :
- Montant initial : ${formatNumber(amount)} XPF
- Jours de retard : ${daysOverdue}
- PÃ©nalitÃ©s (18%/an) : ${formatNumber(penaltiesAmount)} XPF
- IndemnitÃ© forfaitaire : ${formatNumber(forfaitaryIndemnity)} XPF
- TOTAL DÃ› : ${formatNumber(totalDue)} XPF` : '';

        prompt = `Tu es Lionel, propriÃ©taire de DEPANN'FROID en PolynÃ©sie franÃ§aise. RÃ©dige un email de relance FINALE formelle avant mise en demeure pour une facture impayÃ©e.

Informations :
- Nom du client : ${clientName}
- NumÃ©ro de facture : ${documentNumber}
- Montant initial : ${amount} XPF
${dueDate ? `- Date d'Ã©chÃ©ance : ${dueDate}` : ''}
${daysOverdue ? `- Jours de retard : ${daysOverdue}` : ''}
${serviceDescription ? `- Service fourni : ${serviceDescription}` : ''}${penaltyInfo}

Ton : Formel et ferme, dernier avertissement
Structure :
- Objet : MISE EN DEMEURE - Facture ${documentNumber}
- Constat des relances prÃ©cÃ©dentes ignorÃ©es
- Rappel du non-paiement persistant malgrÃ© les relances
- Calcul DÃ‰TAILLÃ‰ et DÃ‰FINITIF des sommes dues (avec pÃ©nalitÃ©s)
- DÃ‰LAI FINAL IMPÃ‰RATIF de 8 jours calendaires
- Mention CLAIRE des actions lÃ©gales Ã  venir :
  * Mise en demeure par lettre recommandÃ©e avec AR
  * ProcÃ©dure judiciaire de recouvrement
  * Frais de procÃ©dure Ã  la charge du dÃ©biteur
  * Inscription Ã©ventuelle aux fichiers d'incidents de paiement
- DerniÃ¨re possibilitÃ© de rÃ¨glement amiable
- Formule formelle et ferme

Ton trÃ¨s formel, sans agressivitÃ© mais sans concession.`;
      }

      prompt += '\n\nRÃ©ponds UNIQUEMENT avec le corps de l\'email. N\'inclus PAS d\'objet, juste le contenu du message.';

      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 2000,
          messages: [{ role: "user", content: prompt }],
        })
      });

      const data = await response.json();
      const emailContent = data.content
        .map(item => (item.type === "text" ? item.text : ""))
        .filter(Boolean)
        .join("\n");
      
      setGeneratedEmail(emailContent.trim());
      await saveToHistory();
    } catch (error) {
      console.error('Erreur:', error);
      setGeneratedEmail('Erreur lors de la gÃ©nÃ©ration.');
    } finally {
      setIsLoading(false);
    }
  };

  const copyToClipboard = async () => {
    try {
      await navigator.clipboard.writeText(generatedEmail);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (error) {
      console.error('Erreur de copie:', error);
    }
  };

  const isReminderType = ['reminder1', 'reminder2', 'final'].includes(documentType);

  const filteredHistory = history.filter(entry => {
    const typeMatch = filterType === 'all' || entry.type === filterType;
    const statusMatch = filterStatus === 'all' || entry.status === filterStatus;
    return typeMatch && statusMatch;
  });

  const getRegisteredLetterContent = (type) => {
    const templates = {
      reminder: `LETTRE RECOMMANDÃ‰E AVEC ACCUSÃ‰ DE RÃ‰CEPTION

DEPANN'FROID
[Votre adresse]
Moorea, PolynÃ©sie FranÃ§aise
TAHITI: [Votre nÂ° TAHITI]

${clientName}
[Adresse du client]

Moorea, le ${new Date().toLocaleDateString('fr-FR')}

Objet : Rappel de facture impayÃ©e - NÂ° ${documentNumber}

Madame, Monsieur,

Nous vous avons adressÃ© plusieurs courriers Ã©lectroniques concernant le rÃ¨glement de notre facture NÂ° ${documentNumber} d'un montant de ${amount} XPF, Ã©chue le ${dueDate}, restÃ©s sans rÃ©ponse de votre part.

Ã€ ce jour, soit ${daysOverdue} jours aprÃ¨s l'Ã©chÃ©ance, cette facture demeure impayÃ©e.

ConformÃ©ment aux dispositions de la loi du Pays nÂ° 2015-4 du 14 avril 2015 portant rÃ©glementation des pratiques commerciales en PolynÃ©sie franÃ§aise, nous vous informons que les pÃ©nalitÃ©s de retard suivantes sont exigibles de plein droit :

DÃ‰COMPTE DES SOMMES DUES :
- Montant initial de la facture : ${amount} XPF
- PÃ©nalitÃ©s de retard (18% par an sur ${daysOverdue} jours) : ${formatNumber(penaltiesAmount)} XPF
- IndemnitÃ© forfaitaire pour frais de recouvrement : 4 800 XPF

MONTANT TOTAL DÃ› : ${formatNumber(totalDue)} XPF

Nous vous mettons en demeure de procÃ©der au rÃ¨glement de cette somme dans un dÃ©lai de HUIT (8) JOURS Ã  compter de la rÃ©ception de la prÃ©sente lettre.

Ã€ dÃ©faut de rÃ¨glement dans ce dÃ©lai, nous serons contraints, Ã  notre grand regret, d'engager une procÃ©dure judiciaire de recouvrement Ã  vos frais et dÃ©pens, sans autre avis de notre part.

Nous restons nÃ©anmoins Ã  votre disposition pour examiner toute proposition de rÃ¨glement amiable qui nous parviendrait avant l'expiration de ce dÃ©lai.

Nous vous prions d'agrÃ©er, Madame, Monsieur, nos salutations distinguÃ©es.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SIGNATURE NUMÃ‰RIQUE
${signature || 'Lionel'}
GÃ©rant - DEPANN'FROID
${signatureImage ? '[Signature Ã©lectronique authentifiÃ©e]' : ''}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

CoordonnÃ©es bancaires pour le rÃ¨glement :
[Vos coordonnÃ©es bancaires]`,

      formal: `MISE EN DEMEURE PAR LETTRE RECOMMANDÃ‰E AVEC AR

DEPANN'FROID
[Votre adresse]
Moorea, PolynÃ©sie FranÃ§aise
TAHITI: [Votre nÂ° TAHITI]

${clientName}
[Adresse du client]

Moorea, le ${new Date().toLocaleDateString('fr-FR')}

MISE EN DEMEURE
Facture impayÃ©e NÂ° ${documentNumber}

Madame, Monsieur,

Par la prÃ©sente lettre recommandÃ©e avec accusÃ© de rÃ©ception, nous vous mettons formellement EN DEMEURE de procÃ©der au rÃ¨glement immÃ©diat de notre facture.

RAPPEL DES FAITS :
- Facture NÂ° ${documentNumber} Ã©mise le ${issueDate}
- Montant : ${amount} XPF
- Date d'Ã©chÃ©ance : ${dueDate}
- Nombre de jours de retard : ${daysOverdue} jours
- Relances restÃ©es sans effet : [nombre] courriers Ã©lectroniques

FONDEMENT JURIDIQUE :
ConformÃ©ment Ã  la loi du Pays nÂ° 2015-4 du 14 avril 2015 portant rÃ©glementation des pratiques commerciales et aux articles du Code de commerce applicables en PolynÃ©sie franÃ§aise, les pÃ©nalitÃ©s de retard sont dues de plein droit dÃ¨s le lendemain de la date d'Ã©chÃ©ance.

MONTANTS EXIGIBLES :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Montant principal HT/TTC : ${amount} XPF      â”‚
â”‚ PÃ©nalitÃ©s de retard (18%/an) : ${formatNumber(penaltiesAmount)} XPF â”‚
â”‚ IndemnitÃ© forfaitaire (art. LP.410-X) : 4 800 XPF â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL EXIGIBLE : ${formatNumber(totalDue)} XPF                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DÃ‰LAI IMPÃ‰RATIF :
Vous disposez d'un dÃ©lai de HUIT (8) JOURS CALENDAIRES Ã  compter de la premiÃ¨re prÃ©sentation de ce courrier pour procÃ©der au rÃ¨glement intÃ©gral de cette somme.

CONSÃ‰QUENCES EN CAS DE NON-RÃˆGLEMENT :
Ã€ l'expiration de ce dÃ©lai, sans rÃ¨glement de votre part et SANS AUTRE AVIS :
1. Saisie du Tribunal de premiÃ¨re instance de Papeete
2. ProcÃ©dure d'injonction de payer ou d'assignation en rÃ©fÃ©rÃ© provision
3. Inscription aux fichiers de la Banque de France (si applicable)
4. Frais de procÃ©dure, d'huissier et d'avocat Ã  votre charge exclusive
5. IntÃ©rÃªts au taux lÃ©gal majorÃ© sur les sommes dues

COORDONNÃ‰ES BANCAIRES :
[Vos coordonnÃ©es bancaires complÃ¨tes]

DERNIÃˆRE POSSIBILITÃ‰ DE RÃˆGLEMENT AMIABLE :
Nous restons ouverts, jusqu'Ã  l'expiration du dÃ©lai ci-dessus, Ã  toute proposition sÃ©rieuse de rÃ¨glement (paiement comptant ou Ã©chelonnÃ© avec garanties).

Fait pour valoir ce que de droit.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SIGNATURE NUMÃ‰RIQUE CERTIFIÃ‰E
${signature || 'Lionel'}
GÃ©rant - DEPANN'FROID
Date: ${new Date().toLocaleDateString('fr-FR')} ${new Date().toLocaleTimeString('fr-FR')}
${signatureImage ? '[Signature Ã©lectronique avec horodatage]' : ''}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Contact: depannfroid@mail.pf
TAHITI: [Votre NÂ° TAHITI]

PiÃ¨ces jointes :
- Copie facture NÂ° ${documentNumber}
- Copies des relances prÃ©cÃ©dentes
- Conditions gÃ©nÃ©rales de vente`
    };
    return templates[type] || '';
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
      {/* Notifications de rappels */}
      {reminders.length > 0 && (
        <div className="fixed top-4 right-4 z-50 max-w-md">
          <div className="bg-white rounded-lg shadow-2xl border-2 border-orange-400 p-4 animate-pulse">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-2">
                <Bell className="w-5 h-5 text-orange-600 animate-bounce" />
                <h3 className="font-bold text-slate-800">Rappels ({reminders.length})</h3>
              </div>
              <button onClick={() => setShowReminders(!showReminders)} className="text-slate-400 hover:text-slate-600">
                {showReminders ? <X className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
              </button>
            </div>
            {showReminders && (
              <div className="space-y-2 max-h-64 overflow-y-auto">
                {reminders.map(reminder => (
                  <div key={reminder.id} className={`p-3 rounded-lg ${reminder.type === 'overdue' ? 'bg-red-50 border border-red-200' : 'bg-yellow-50 border border-yellow-200'}`}>
                    <div className="font-medium text-sm">{reminder.client}</div>
                    <div className="text-xs text-slate-600">{reminder.docNumber}</div>
                    <div className="text-xs font-semibold mt-1">
                      {reminder.type === 'overdue' ? (
                        <span className="text-red-600">âš ï¸ Retard: {reminder.daysOverdue} jours - {formatNumber(reminder.amount)} XPF</span>
                      ) : (
                        <span className="text-orange-600">ğŸ“… Ã‰chÃ©ance dans {reminder.daysUntil} jours</span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {/* Import Preview Modal */}
      {showImportPreview && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl p-6 max-w-4xl w-full max-h-[80vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold text-slate-800">PrÃ©visualisation Import</h2>
              <button onClick={() => setShowImportPreview(false)} className="text-slate-400 hover:text-slate-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            <p className="text-sm text-slate-600 mb-4">{importedData.length} facture(s) dÃ©tectÃ©e(s)</p>
            <div className="overflow-x-auto mb-4">
              <table className="w-full text-sm">
                <thead>
                  <tr className="bg-slate-100">
                    <th className="p-2 text-left">Client</th>
                    <th className="p-2 text-left">NÂ° Facture</th>
                    <th className="p-2 text-right">Montant</th>
                    <th className="p-2 text-left">Ã‰chÃ©ance</th>
                  </tr>
                </thead>
                <tbody>
                  {importedData.map((item, idx) => (
                    <tr key={idx} className="border-b hover:bg-slate-50">
                      <td className="p-2">{item.client}</td>
                      <td className="p-2">{item.numero}</td>
                      <td className="p-2 text-right">{formatNumber(item.montant)} XPF</td>
                      <td className="p-2">{item.echeance}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="flex gap-3">
              <button onClick={confirmImport} className="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition">
                Confirmer l'import
              </button>
              <button onClick={() => setShowImportPreview(false)} className="flex-1 bg-slate-200 text-slate-700 py-3 px-6 rounded-lg font-semibold hover:bg-slate-300 transition">
                Annuler
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Header */}
      <div className="relative overflow-hidden">
        <div className="absolute inset-0 bg-gradient-to-r from-blue-600/5 to-indigo-600/5"></div>
        <div className="relative max-w-7xl mx-auto px-6 py-6">
          <div className="text-center">
            <div className="inline-flex items-center justify-center w-14 h-14 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl mb-3 shadow-lg">
              <Receipt className="w-7 h-7 text-white" />
            </div>
            <h1 className="text-2xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text text-transparent mb-1">
              Factures Devis Relances Pro
            </h1>
            <p className="text-sm text-slate-600">DEPANN'FROID - Solution ComplÃ¨te</p>
          </div>
        </div>
      </div>

      {/* Navigation Tabs */}
      <div className="max-w-7xl mx-auto px-6 mb-6">
        <div className="bg-white/70 backdrop-blur-sm rounded-xl p-2 shadow-lg border border-white/20">
          <div className="flex gap-2 flex-wrap">
            {[
              { id: 'new', label: 'Nouveau', icon: FileText },
              { id: 'history', label: 'Historique', icon: History },
              { id: 'stats', label: 'Statistiques', icon: BarChart3 },
              { id: 'letters', label: 'Lettres AR', icon: Mail },
              { id: 'import', label: 'Import', icon: Upload },
              { id: 'signature', label: 'Signature', icon: FileSignature }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all ${
                  activeTab === tab.id
                    ? 'bg-blue-600 text-white shadow-md'
                    : 'text-slate-600 hover:bg-slate-100'
                }`}
              >
                <tab.icon className="w-4 h-4" />
                <span className="text-sm">{tab.label}</span>
              </button>
            ))}
          </div>
        </div>
      </div>

      {/* Content based on active tab */}
      <div className="max-w-7xl mx-auto px-6 pb-12">
        {activeTab === 'new' && (
          <div className="grid lg:grid-cols-2 gap-6">
            {/* Left Column - Input */}
            <div className="space-y-4">
              <div className="bg-white/70 backdrop-blur-sm rounded-xl p-5 shadow-xl border border-white/20">
                <h2 className="text-lg font-semibold text-slate-800 mb-3">Type de Document</h2>
                <div className="grid grid-cols-2 gap-2">
                  {documentTypes.map((type) => {
                    const colors = getColorClasses(type.color);
                    return (
                      <button
                        key={type.value}
                        onClick={() => setDocumentType(type.value)}
                        className={`p-3 rounded-lg border-2 transition-all text-left ${
                          documentType === type.value
                            ? `${colors.border} ${colors.bg} shadow-md`
                            : `border-slate-200 bg-white/50 ${colors.hover}`
                        }`}
                      >
                        <div className="flex items-center gap-2 mb-1">
                          <span className="text-lg">{type.icon}</span>
                          <div className="font-semibold text-xs text-slate-800">{type.label}</div>
                        </div>
                        <div className="text-xs text-slate-600">{type.description}</div>
                      </button>
                    );
                  })}
                </div>
              </div>

              <div className="bg-white/70 backdrop-blur-sm rounded-xl p-5 shadow-xl border border-white/20">
                <h2 className="text-lg font-semibold text-slate-800 mb-3">Informations</h2>
                <div className="space-y-3">
                  <input
                    type="text"
                    value={clientName}
                    onChange={(e) => setClientName(e.target.value)}
                    placeholder="Nom du client *"
                    className="w-full p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white/50"
                  />
                  
                  <div className="grid grid-cols-2 gap-2">
                    <input
                      type="text"
                      value={documentNumber}
                      onChange={(e) => setDocumentNumber(e.target.value)}
                      placeholder={documentType === 'quote' ? 'NÂ° Devis *' : 'NÂ° Facture *'}
                      className="w-full p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white/50"
                    />
                    <input
                      type="text"
                      value={amount}
                      onChange={(e) => setAmount(e.target.value)}
                      placeholder="Montant XPF *"
                      className="w-full p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white/50"
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    {documentType === 'quote' ? (
                      <>
                        <input type="text" value={issueDate} onChange={(e) => setIssueDate(e.target.value)} placeholder="Date Ã©mission" className="w-full p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white/50" />
                        <input type="text" value={validityDays} onChange={(e) => setValidityDays(e.target.value)} placeholder="ValiditÃ© (jours)" className="w-full p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white/50" />
                      </>
                    ) : (
                      <>
                        <input type="text" value={isReminderType ? dueDate : issueDate} onChange={(e) => isReminderType ? setDueDate(e.target.value) : setIssueDate(e.target.value)} placeholder={isReminderType ? 'Date Ã©chÃ©ance' : 'Date Ã©mission'} className="w-full p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white/50" />
                        {isReminderType ? (
                          <input type="text" value={daysOverdue} onChange={(e) => setDaysOverdue(e.target.value)} placeholder="Jours retard" className="w-full p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white/50" />
                        ) : (
                          <input type="text" value={dueDate} onChange={(e) => setDueDate(e.target.value)} placeholder="Date Ã©chÃ©ance" className="w-full p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white/50" />
                        )}
                      </>
                    )}
                  </div>

                  <textarea
                    value={serviceDescription}
                    onChange={(e) => setServiceDescription(e.target.value)}
                    placeholder="Description du service"
                    className="w-full h-16 p-2 border border-slate-200 rounded-lg text-sm resize-none focus:ring-2 focus:ring-blue-500 bg-white/50"
                  />
                </div>
              </div>

              {isReminderType && daysOverdue && amount && (
                <div className="bg-gradient-to-br from-orange-50 to-red-50 rounded-xl p-4 shadow-xl border border-orange-200">
                  <div className="flex items-center gap-2 mb-3">
                    <Calculator className="w-5 h-5 text-orange-600" />
                    <h2 className="text-base font-semibold text-slate-800">Calcul PÃ©nalitÃ©s</h2>
                  </div>
                  <div className="space-y-2 text-sm">
                    <div className="flex justify-between"><span>Montant initial</span><span className="font-semibold">{formatNumber(amount)} XPF</span></div>
                    <div className="flex justify-between"><span>PÃ©nalitÃ©s (18%)</span><span className="font-semibold text-orange-600">{formatNumber(penaltiesAmount)} XPF</span></div>
                    <div className="flex justify-between"><span>IndemnitÃ©</span><span className="font-semibold text-orange-600">{formatNumber(forfaitaryIndemnity)} XPF</span></div>
                    <div className="flex justify-between pt-2 border-t-2 border-orange-300"><span className="font-bold">TOTAL DÃ›</span><span className="text-lg font-bold text-red-600">{formatNumber(totalDue)} XPF</span></div>
                  </div>
                </div>
              )}

              <button
                onClick={generateEmail}
                disabled={isLoading || !clientName || !documentNumber || !amount}
                className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-6 rounded-xl font-semibold shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                {isLoading ? (
                  <><div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>GÃ©nÃ©ration...</>
                ) : (
                  <><Send className="w-4 h-4" />GÃ©nÃ©rer l'Email</>
                )}
              </button>
            </div>

            {/* Right Column - Output */}
            <div className="space-y-4">
              <div className="bg-white/70 backdrop-blur-sm rounded-xl p-5 shadow-xl border border-white/20 min-h-96">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-lg font-semibold text-slate-800">Email GÃ©nÃ©rÃ©</h2>
                  <div className="flex gap-2">
                    {generatedEmail && (
                      <>
                        <button onClick={copyToClipboard} className="flex items-center gap-1 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg text-xs font-medium">
                          {copied ? <><Check className="w-3 h-3 text-green-600" />CopiÃ©</> : <><Copy className="w-3 h-3" />Copier</>}
                        </button>
                        <button onClick={exportToPDF} className="flex items-center gap-1 px-3 py-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-xs font-medium">
                          <Download className="w-3 h-3" />PDF
                        </button>
                      </>
                    )}
                  </div>
                </div>
                {generatedEmail ? (
                  <div className="bg-white/80 rounded-lg p-4 border border-slate-200 max-h-[500px] overflow-y-auto">
                    <pre className="whitespace-pre-wrap font-sans text-slate-700 text-sm leading-relaxed">{generatedEmail}</pre>
                  </div>
                ) : (
                  <div className="flex flex-col items-center justify-center h-48 text-slate-400">
                    <Receipt className="w-12 h-12 mb-3 opacity-50" />
                    <p className="text-sm">Votre email apparaÃ®tra ici</p>
                  </div>
                )}
              </div>

              <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-100">
                <h3 className="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
                  <AlertCircle className="w-4 h-4 text-blue-600" />
                  Infos LÃ©gales PF
                </h3>
                <ul className="text-xs text-slate-600 space-y-1">
                  <li>â€¢ Taux: 18%/an (min 11,13%)</li>
                  <li>â€¢ IndemnitÃ©: 4 800 XPF/facture</li>
                  <li>â€¢ DÃ©lai: 30j (60j max)</li>
                  <li>â€¢ Signature numÃ©rique activÃ©e âœ“</li>
                </ul>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'history' && (
          <div className="space-y-4">
            <div className="bg-white/70 backdrop-blur-sm rounded-xl p-5 shadow-xl border border-white/20">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-semibold text-slate-800">Historique des Envois</h2>
                <div className="flex gap-2">
                  <select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="px-3 py-1.5 border border-slate-200 rounded-lg text-sm bg-white">
                    <option value="all">Tous types</option>
                    {documentTypes.map(t => <option key={t.value} value={t.value}>{t.label}</option>)}
                  </select>
                  <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="px-3 py-1.5 border border-slate-200 rounded-lg text-sm bg-white">
                    <option value="all">Tous statuts</option>
                    <option value="sent">EnvoyÃ©</option>
                    <option value="paid">PayÃ©</option>
                    <option value="pending">En attente</option>
                  </select>
                </div>
              </div>
              
              {filteredHistory.length === 0 ? (
                <div className="text-center py-12 text-slate-400">
                  <History className="w-16 h-16 mx-auto mb-4 opacity-50" />
                  <p>Aucun historique</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {filteredHistory.map(entry => (
                    <div key={entry.id} className="bg-white/80 rounded-lg p-4 border border-slate-200">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <div className="font-semibold text-slate-800">{entry.clientName}</div>
                          <div className="text-sm text-slate-600">{entry.documentNumber} - {formatNumber(entry.amount)} XPF</div>
                          <div className="text-xs text-slate-500 mt-1">{new Date(entry.date).toLocaleString('fr-FR')}</div>
                        </div>
                        <div className="flex items-center gap-2">
                          <select value={entry.status} onChange={(e) => updateEntryStatus(entry.id, e.target.value)} className="px-2 py-1 text-xs border border-slate-200 rounded bg-white">
                            <option value="sent">EnvoyÃ©</option>
                            <option value="paid">PayÃ©</option>
                            <option value="pending">En attente</option>
                          </select>
                          <button onClick={() => deleteEntry(entry.id)} className="p-1.5 text-red-600 hover:bg-red-50 rounded">
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                      {entry.penaltiesAmount > 0 && (
                        <div className="text-xs text-orange-600 mt-2 p-2 bg-orange-50 rounded">
                          PÃ©nalitÃ©s: {formatNumber(entry.penaltiesAmount)} XPF | Total: {formatNumber(entry.totalDue)} XPF
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {activeTab === 'stats' && (
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div className="bg-white/70 backdrop-blur-sm rounded-xl p-6 shadow-xl border border-white/20">
              <div className="flex items-center gap-3 mb-4">
                <div className="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                  <Send className="w-6 h-6 text-blue-600" />
                </div>
                <div>
                  <div className="text-2xl font-bold text-slate-800">{stats.totalSent}</div>
                  <div className="text-sm text-slate-600">Documents envoyÃ©s</div>
                </div>
              </div>
            </div>

            <div className="bg-white/70 backdrop-blur-sm rounded-xl p-6 shadow-xl border border-white/20">
              <div className="flex items-center gap-3 mb-4">
                <div className="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                  <TrendingUp className="w-6 h-6 text-green-600" />
                </div>
                <div>
                  <div className="text-2xl font-bold text-slate-800">{formatNumber(stats.totalRecovered)}</div>
                  <div className="text-sm text-slate-600">XPF recouvrÃ©s</div>
                </div>
              </div>
            </div>

            <div className="bg-white/70 backdrop-blur-sm rounded-xl p-6 shadow-xl border border-white/20">
              <div className="flex items-center gap-3 mb-4">
                <div className="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                  <AlertCircle className="w-6 h-6 text-orange-600" />
                </div>
                <div>
                  <div className="text-2xl font-bold text-slate-800">{formatNumber(stats.pendingAmount)}</div>
                  <div className="text-sm text-slate-600">XPF en attente</div>
                </div>
              </div>
            </div>

            <div className="md:col-span-2 lg:col-span-3 bg-white/70 backdrop-blur-sm rounded-xl p-6 shadow-xl border border-white/20">
              <h3 className="text-lg font-semibold text-slate-800 mb-4">RÃ©partition par type</h3>
              <div className="grid grid-cols-5 gap-4">
                {documentTypes.map(type => (
                  <div key={type.value} className="text-center">
                    <div className="text-3xl mb-2">{type.icon}</div>
                    <div className="text-2xl font-bold text-slate-800">{stats.byType[type.value] || 0}</div>
                    <div className="text-xs text-slate-600">{type.label}</div>
                  </div>
                ))}
              </div>
            </div>

            <div className="md:col-span-2 lg:col-span-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
              <h3 className="text-lg font-semibold text-slate-800 mb-3">Taux de recouvrement</h3>
              <div className="text-4xl font-bold text-blue-600 mb-2">
                {stats.totalAmount > 0 ? Math.round((stats.totalRecovered / (stats.totalAmount + stats.totalRecovered)) * 100) : 0}%
              </div>
              <div className="w-full bg-slate-200 rounded-full h-4">
                <div className="bg-gradient-to-r from-blue-500 to-green-500 h-4 rounded-full" style={{width: `${stats.totalAmount > 0 ? (stats.totalRecovered / (stats.totalAmount + stats.totalRecovered)) * 100 : 0}%`}}></div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'letters' && (
          <div className="grid lg:grid-cols-2 gap-6">
            <div className="bg-white/70 backdrop-blur-sm rounded-xl p-6 shadow-xl border border-white/20">
              <h2 className="text-xl font-semibold text-slate-800 mb-4">Lettre de Relance AR</h2>
              <p className="text-sm text-slate-600 mb-4">ModÃ¨le avec signature numÃ©rique certifiÃ©e</p>
              <div className="bg-slate-50 rounded-lg p-4 max-h-96 overflow-y-auto mb-4">
                <pre className="whitespace-pre-wrap text-xs font-mono">{getRegisteredLetterContent('reminder')}</pre>
              </div>
              <button onClick={() => {
                const blob = new Blob([getRegisteredLetterContent('reminder')], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Relance-AR-${documentNumber}-SIGNE.txt`;
                a.click();
              }} className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                <Download className="w-4 h-4" />
                TÃ©lÃ©charger avec signature
              </button>
            </div>

            <div className="bg-white/70 backdrop-blur-sm rounded-xl p-6 shadow-xl border border-white/20">
              <h2 className="text-xl font-semibold text-slate-800 mb-4">Mise en Demeure Formelle</h2>
              <p className="text-sm text-slate-600 mb-4">Document juridique avec horodatage</p>
              <div className="bg-slate-50 rounded-lg p-4 max-h-96 overflow-y-auto mb-4">
                <pre className="whitespace-pre-wrap text-xs font-mono">{getRegisteredLetterContent('formal')}</pre>
              </div>
              <button onClick={() => {
                const blob = new Blob([getRegisteredLetterContent('formal')], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Mise-en-demeure-${documentNumber}-CERTIFIE.txt`;
                a.click();
              }} className="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition flex items-center justify-center gap-2">
                <Download className="w-4 h-4" />
                TÃ©lÃ©charger certifiÃ©
              </button>
            </div>
          </div>
        )}

        {activeTab === 'import' && (
          <div className="bg-white/70 backdrop-blur-sm rounded-xl p-6 shadow-xl border border-white/20">
            <h2 className="text-xl font-semibold text-slate-800 mb-4">Import CSV / Excel</h2>
            <div className="mb-6">
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <h3 className="font-semibold text-blue-900 mb-2">ğŸ“‹ Format attendu</h3>
                <p className="text-sm text-blue-800 mb-3">Votre fichier CSV doit contenir ces colonnes dans cet ordre :</p>
                <div className="bg-white rounded p-3 font-mono text-xs">
                  Client,NÂ° Facture,Montant,Ã‰chÃ©ance<br/>
                  Restaurant Le Mahana,FAC-2024-001,85000,15/12/2024<br/>
                  HÃ´tel Tiare,FAC-2024-002,120000,20/12/2024
                </div>
              </div>
              
              <div className="border-2 border-dashed border-slate-300 rounded-xl p-12 text-center hover:border-blue-400 transition">
                <Upload className="w-16 h-16 mx-auto mb-4 text-slate-400" />
                <p className="text-slate-600 mb-2 font-medium">Glissez votre fichier ici ou cliquez pour sÃ©lectionner</p>
                <p className="text-sm text-slate-500 mb-4">CSV ou Excel (.xlsx, .xls, .csv)</p>
                <input
                  type="file"
                  accept=".csv,.xlsx,.xls"
                  onChange={handleFileImport}
                  className="hidden"
                  id="file-upload"
                />
                <label htmlFor="file-upload" className="inline-block bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition cursor-pointer">
                  SÃ©lectionner un fichier
                </label>
              </div>
            </div>
            
            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
              <h3 className="font-semibold text-green-900 mb-2">âœ… FonctionnalitÃ©s</h3>
              <ul className="text-sm text-green-800 space-y-1">
                <li>â€¢ Import massif de factures</li>
                <li>â€¢ PrÃ©visualisation avant validation</li>
                <li>â€¢ DÃ©tection automatique des Ã©chÃ©ances proches</li>
                <li>â€¢ Calcul automatique des rappels nÃ©cessaires</li>
              </ul>
            </div>
          </div>
        )}

        {activeTab === 'signature' && (
          <div className="grid lg:grid-cols-2 gap-6">
            <div className="bg-white/70 backdrop-blur-sm rounded-xl p-6 shadow-xl border border-white/20">
              <h2 className="text-xl font-semibold text-slate-800 mb-4">Signature NumÃ©rique</h2>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-2">
                    Signature texte
                  </label>
                  <input
                    type="text"
                    value={signature}
                    onChange={(e) => setSignature(e.target.value)}
                    placeholder="Ex: Lionel - GÃ©rant DEPANN'FROID"
                    className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-2">
                    Image de signature (optionnel)
                  </label>
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept="image/*"
                    onChange={handleImageUpload}
                    className="hidden"
                  />
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 py-3 px-4 rounded-lg transition flex items-center justify-center gap-2"
                  >
                    <FileSignature className="w-4 h-4" />
                    {signatureImage ? 'Changer l\'image' : 'Ajouter une image'}
                  </button>
                  
                  {signatureImage && (
                    <div className="mt-3 p-3 bg-slate-50 rounded-lg">
                      <img src={signatureImage} alt="Signature" className="max-h-24 mx-auto" />
                      <button
                        onClick={() => setSignatureImage(null)}
                        className="mt-2 text-xs text-red-600 hover:text-red-700 mx-auto block"
                      >
                        Supprimer l'image
                      </button>
                    </div>
                  )}
                </div>

                <button
                  onClick={saveSignature}
                  className="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition"
                >
                  Enregistrer la signature
                </button>
              </div>
            </div>

            <div className="bg-white/70 backdrop-blur-sm rounded-xl p-6 shadow-xl border border-white/20">
              <h2 className="text-xl font-semibold text-slate-800 mb-4">PrÃ©visualisation</h2>
              
              <div className="bg-slate-50 rounded-lg p-6 border-2 border-slate-200">
                <p className="text-sm text-slate-600 mb-4">Votre signature apparaÃ®tra ainsi sur les documents :</p>
                
                <div className="border-t-2 border-slate-300 pt-4">
                  <div className="text-center">
                    <p className="text-sm text-slate-500 mb-2">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</p>
                    <p className="font-semibold text-slate-800">SIGNATURE NUMÃ‰RIQUE</p>
                    <p className="text-slate-700 my-2">{signature || 'Lionel'}</p>
                    {signatureImage && (
                      <img src={signatureImage} alt="Signature" className="max-h-20 mx-auto my-2" />
                    )}
                    <p className="text-xs text-slate-500 mt-2">GÃ©rant - DEPANN'FROID</p>
                    <p className="text-xs text-slate-400">Horodatage: {new Date().toLocaleString('fr-FR')}</p>
                    <p className="text-sm text-slate-500 mt-2">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</p>
                  </div>
                </div>
              </div>

              <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 className="font-semibold text-blue-900 mb-2">ğŸ”’ SÃ©curitÃ©</h3>
                <ul className="text-sm text-blue-800 space-y-1">
                  <li>â€¢ Signature horodatÃ©e automatiquement</li>
                  <li>â€¢ AjoutÃ©e Ã  tous les documents officiels</li>
                  <li>â€¢ Conforme aux exigences lÃ©gales PF</li>
                  <li>â€¢ StockÃ©e localement de maniÃ¨re sÃ©curisÃ©e</li>
                </ul>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
